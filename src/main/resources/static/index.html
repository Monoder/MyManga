<!DOCTYPE html>
<html lang="ch">
<head>
    <meta charset="UTF-8">
    <title>index</title>
    <link rel="stylesheet" href="css/public-frame.css">
    <script src="./js/frame/jquery-3.6.0.js"></script>
    <script src="./js/public/public-frame.js"></script>
    <script src="./js/public/public-navigation.js"></script>
    <style>
        #head-wrapper {z-index:100;width:600px;height:160px;margin:0 auto;padding:5px;border-collapse:collapse;text-align:left;}
        #category-wrapper {position:relative;z-index:0;width:600px;height:100px;min-height:30px;max-height:260px;text-align:center;}
        #category-table {margin:0 auto;border-spacing:6px;}
        #search-form {display:flex;}
        #input-wrapper {display:inline-block;position:relative;width:500px;vertical-align:top;}
        #search-content {width:512px;height:16px;overflow:hidden;margin:0;padding:12px 16px;border-radius:10px 0 0 10px;box-shadow:none;outline:0;font-size:16px;vertical-align:top;-webkit-tap-highlight-color:transparent;color:#222;background:#FFF;border:2px solid #C4C7CE;box-sizing:content-box;}
        #button-wrapper {position:relative;z-index:2;width:100px;height:44px;}
        #search-btn {width:100px;height:44px;padding:0;border-radius:0 10px 10px 0;box-shadow:none;outline:0;font-family:等线, sans-serif;font-size:17px;font-weight:400;color:#FFF;background:#4E6EF2 0 0;cursor:pointer;border:none;}
        #search-btn:active, #search-btn:hover, #search-btn:focus {outline:0;background:radial-gradient(#4662D9, #4662D9) !important;}
        #input-wrapper:hover #search-content {border-color:#A7AAB5;}
        #search-content:focus {border-color:#4E6EF2 !important;opacity:1;filter:alpha(opacity=100);}
        .search-input::placeholder, .search-input::-moz-placeholder, .search-input:-ms-input-placeholder, .search-input::-webkit-input-placeholder {padding-left:3px;font-size:13px;color:#AAA;}
        .content-wrapper {display:flex;width:258px;height:427px;margin:5px;padding-bottom:2px;border-radius:10px;color:cornsilk;background:#5f636b;flex-direction:column;border:1px solid rgba(72, 61, 139, 0.8);}
        .content-title {display:-webkit-box;min-height:32px;max-height:32px;overflow:hidden;margin:3px auto;padding:0 3px;font-size:10pt;line-height:16px;text-align:left;-webkit-box-orient:vertical;-webkit-line-clamp:2;}
        .content-body{display:flex;top:-2px;max-width:240px;max-height:340px;margin:auto;align-items:center;}
        .wrapper-source{width:100%;height:100%;margin:auto 0;padding-bottom:5px;text-decoration:none;}
        .wrapper-source img{max-width:100%;max-height:100%;margin:0 auto;border-radius:5px;background:rgba(0, 0, 0, 0.3);border:1px solid #000000;}
        .content-foot {display:flex;height:50px;justify-content:space-between;align-items:center;}
        .foot-left {display:flex;width:170px;flex-direction:column;justify-content:space-between;align-items:center;}
        .foot-left .category{position:relative;width:70px;height:18px;line-height:16px;}
        .foot-right {width:85px;margin-left:auto;}
        table.page-bar{clear:both;padding:0px;border-collapse:collapse;font-size:10pt;}
        table.page-bar tr{background:rgba(0,139,139,0.8);}
        table.page-bar td{width:31px;height:20px;font-size:14px;text-align:center;cursor:pointer;border:1px solid rgba(72,61,139,0.8);}
        table.page-bar td:hover{font-size:18px;font-weight:bold;color:rgba(255,255,255,1);background:rgba(0,0,0,0.2);}
        td.page_num{font-weight:bold;color:aqua;}
        td.page_num[data-isCurrent=true]{font-size:14px;color:rgba(255,255,255,1);background:rgba(0,0,0,0.4);}
        td.page_num:hover[data-isCurrent=true]{font-size:14px;color:rgba(255,255,255,1);background:rgba(0,0,0,0.4);}
        td.page_change{color:aqua;}
        td.page_change[data-isShow=false]{display:none;}
        td.page_change:hover{color:rgba(255,255,255,1);}
    </style>
</head>
<body>
<div id="base-container">
    <header id="head-container">
        <h1 id="base-title">Monoder - Just For Fun</h1>
        <div id="head-wrapper">
            <div id="category-wrapper">
                <table id="category-table">
                    <tbody>
                    <tr>
                        <td>
                            <div data-id="42390000" class="category">Doujinshi</div>
                        </td>
                        <td>
                            <div data-id="42391111" class="category">Manga</div>
                        </td>
                        <td>
                            <div data-id="42392222" class="category">Artist CG</div>
                        </td>
                        <td>
                            <div data-id="42393333" class="category">Game CG</div>
                        </td>
                        <td>
                            <div data-id="42394444" class="category">Western</div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div data-id="42395555" class="category">Non-H</div>
                        </td>
                        <td>
                            <div data-id="42396666" class="category">Image Set</div>
                        </td>
                        <td>
                            <div data-id="42397777" class="category">Cosplay</div>
                        </td>
                        <td>
                            <div data-id="42398888" class="category">Asian Porn</div>
                        </td>
                        <td>
                            <div data-id="42399999" class="category">Misc</div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <form id="search-form">
                <span id="input-wrapper">
                    <input id="search-content" class="search-input" maxlength="255" autocomplete="off">
                </span>
                <span id="button-wrapper">
                    <input type="button" id="search-btn" value="Search" onclick="searchSubmit( )">
                </span>
            </form>
        </div>
    </header>

    <main id="body-container">
        <p class="info">Showing <strong></strong> results</p>
        <table class="page-bar" style="margin:2px auto 0">
            <tr></tr>
        </table>

        <div id="body-wrapper" class="body-grid">
        </div>

        <table class="page-bar" style="margin:0 auto">
            <tr></tr>
        </table>

    </main>

</div>
</body>
<script>
    // 设置页数
    let pages = 2;
    let pageNum = 1;
    // 定义常用的 jQuery 对象
    const sel_$category = ".category";
    const sel_$bodyWrapper = "#body-wrapper";
    const sel_$bodyContainer_Info = "#body-container .info";
    const sel_$contentBody_Img = ".content-body img";
    const sel_$pageBar_Tr = ".page-bar tr";
    let $category = $(sel_$category);
    let $bodyWrapper = $(sel_$bodyWrapper);
    let $bodyContainer_Info = $(sel_$bodyContainer_Info);
    let $contentBody_Img = $(sel_$contentBody_Img);
    let $pageBar_Tr = $(sel_$pageBar_Tr);

    // 加载框架
    $(document).ready(function () {
        // 封装 DataTables 类型数据用于发送请求
        let dataTablesData = {pageNum: pageNum};
        let postData = getDataTablesPostData(dataTablesData);
        let listMangeInfo = $.ajax({
            type: "post",
            url: "/MangaInfo/listMangaInfo",
            dataType: "JSON",
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify(postData),
            success: (response) => {
                pageReload(response);
            },
            error: () => {
            }
        });

        // listMangeInfo 加载完成后执行
        listMangeInfo.done(function (response) {
            let searchData = response.searchData;
            $category = $(sel_$category);
            initCategoryBar($category, searchData.searchText, searchData.categoryIdList);
        });

        // 分类的点击切换事件
        $category = $(sel_$category);
        $category.click(function () {
            let that = $(this);
            if (that.attr("data-disabled") === undefined) {
                that.attr("data-disabled", "");
            } else {
                that.removeAttr("data-disabled");
            }
        });

    });

    // 搜索框提交
    function searchSubmit() {
        // 获取搜索内容
        let searchText = $("#search-content").val();
        // 遍历获取CategoryIdList
        let categoryIdList = [];
        $category = $(sel_$category);
        $category.each(function () {
            if (!$(this).attr("data-disabled")) {
                categoryIdList.push($(this).attr("data-id"));
            }
        });
        // 封装 SearchData 类型数据用于发送请求
        let searchData = {searchText: searchText, categoryIdList: categoryIdList};
        // 发送请求重载页面
        searchPageLoad(searchData);
    }


    /**
     *  渲染页面漫画封面的容器框架部分
     *  let $bodyWrapper = $("#manga-wrapper");
     * @param $bodyWrapper  ( #manga-wrapper ) 漫画封面的 jQuery 对象
     * @param pageInfo  PageHelper 分页后的结果集合
     */
    function initWrapperContainer($bodyWrapper, pageInfo) {
        // 获取数据
        let listMangaInfo = pageInfo.list;
        listMangaInfo.forEach((mangaInfo) => {
            let {
                guid: mangaGuid,
                mangaName,
                pageCount: mangaPageCount,
                updateTime: mangaUpdateTime,
                dicEnumCategoryDTO: mangaCategory
            } = mangaInfo;
            mangaUpdateTime = formatDateString(mangaUpdateTime);
            // 使用模板字符串
            $bodyWrapper.append(`
            <div class="content-wrapper">
                <div class="content-title" title="${mangaName}">
                    <a href="/web/MangaDetail.html?mainGuid=${mangaGuid}">${mangaName}</a>
                </div>
                <div class="content-body">
                    <a class="wrapper-source" href="/web/MangaDetail.html?mainGuid=${mangaGuid}">
                        <img data-id="${mangaGuid}" alt="${mangaName}"/>
                    </a>
                </div>
                <div class="content-foot">
                    <div class="foot-left">
                        <div class="category category-wrapper" data-id="${mangaCategory.dicEnumID}">${mangaCategory.dicEnumName}</div>
                        <p class="info-date">${mangaUpdateTime}</p>
                    </div>
                    <div class="foot-right">${mangaPageCount} pages</div>
                </div>
            </div>
    `);
        });
    }

    /**
     * 请求并渲染页面的漫画封面
     * let $contentBody_Img = $(".content-body img");
     * @param $contentBody_Img (.content-body img) 漫画封面图片部分的 jQuery 对象
     */
    function initWrapperSource($contentBody_Img) {
        // 在框架中根据封面 Guid 循环请求封面图片
        $contentBody_Img.each((index, element) => {
            let wrapperGuid = $(element).attr("data-id");
            $.ajax({
                type: "post",
                // dataType: "text",
                data: {mangaGuid: wrapperGuid},
                url: "/MangaInfo/getWrapper",
                success: (wrapperSource) => {
                    $(element).attr("src", wrapperSource);
                },
                error: (xhr, textStatus, errorThrown) => {
                    console.log(xhr.responseText);
                }
            })
        });
    }

    /**
     * 分类栏加载后渲染分类栏的 data-isChoose，使得支持点击切换样式
     *  let $category = $( ".category" );
     * @param $category  ( .category ) 的 jQuery 对象
     * @param searchText  搜索框搜索内容文本
     * @param categoryIdList  选择的分类ID集合
     */
    function initCategoryBar($category, searchText, categoryIdList) {
        // 判断 categoryIdList 是否为空，为空则默认加载为 true
        if (categoryIdList.length === 0) {
            $category.attr("data-isChoose", true);
        } else {
            // categoryIdList 不为空，则遍历 dom 树，判断传参集合里是否包含 dom 的 data-id
            $category.each((index, element) => {
                let $cat = $(element);
                let $catId = $cat.attr("data-id");
                if (categoryIdList.length === 0 || categoryIdList.indexOf($catId) >= 0) {
                    $cat.attr("data-isChoose", true);
                } else {
                    $cat.attr("data-isChoose", false);
                }
            });
        }
    }

    /**
     * 渲染分页栏
     * let $pageBar_Tr = $(".page_bar tr");
     * @param $pageBar_Tr   ( .page_bar tr ) 分页栏渲染的 jQuery 对象
     * @param pageInfo - PageHelper 分页后的结果集合
     */
    function initPageBar($pageBar_Tr, pageInfo) {
        // 获取当前页和总页数
        let {pageNum, pages} = pageInfo;

        // 定义跳转页数的函数
        let changePage = newPageNum => {
            pageNum = newPageNum;
            pageChangeLoad(pageNum);
        };

        // 计算页码的起始和结束位置
        let pageStart = 1;
        let pageEnd = pages;
        if (pages > 5) {
            if (pageNum <= 3) {
                pageEnd = 5;
            } else if (pageNum >= pages - 2) {
                pageStart = pages - 4;
            } else {
                pageStart = pageNum - 2;
                pageEnd = pageNum + 2;
            }
        }

        // 渲染页码元素
        $pageBar_Tr.empty().append(`
    <td class="page_change" onclick="getPreviousPage()" data-isShow="${pageInfo.hasPreviousPage}">&lt;</td>
    ${pageStart > 1 ? `<td class="page_num" onclick="pageChange(1)">1</td>
                        <td class="page_num" onclick="pageChange(${pageStart - 1})">...</td>` : ""}
    ${Array.from({length: pageEnd - pageStart + 1}, (_, i) => pageStart + i)
            .map(page => `<td class="page_num" onclick="pageChange(${page})" data-isCurrent="${page === pageNum}">${page}</td>`)
            .join("")}
    ${pageEnd < pages ? `<td class="page_num" onclick="pageChange(${pageEnd + 1})">...</td>
                        <td class="page_num" onclick="pageChange(${pages})">${pages}</td>` : ""}
    <td class="page_change" onclick="getNextPage()" data-isShow="${pageInfo.hasNextPage}">&gt;</td>
  `);
    }

    function pageChange(targetPageNum) {
        pageNum = targetPageNum;
        pageChangeLoad(pageNum);
    }

    function getPreviousPage() {
        if (pageNum > 1) {
            pageNum--;
            pageChangeLoad(pageNum);
        }
    }

    function getNextPage() {
        if (pageNum < pages) {
            pageNum++;
            pageChangeLoad(pageNum);
        }
    }


    function pageReload(responseData) {
        let pageInfo = responseData.data;
        pages = pageInfo.pages;

        // 渲染页面提示信息
        $bodyContainer_Info = $(sel_$bodyContainer_Info);
        $bodyContainer_Info.empty().text("Showing " + pageInfo.total + " results");

        // 渲染图片框架
        $bodyWrapper = $(sel_$bodyWrapper);
        $bodyWrapper.empty();
        initWrapperContainer($bodyWrapper, pageInfo);

        // 图片资源渲染
        $contentBody_Img = $(sel_$contentBody_Img);
        $contentBody_Img.empty();
        initWrapperSource($contentBody_Img);

        // 分页实现
        $pageBar_Tr = $(sel_$pageBar_Tr);
        $pageBar_Tr.empty();
        initPageBar($pageBar_Tr, pageInfo);
    }

    /**
     * 根据页码请求后台新的分页数据
     * @param pageNum
     */
    function pageChangeLoad(pageNum) {
        let originalData = {pageNum};
        let postData = getDataTablesPostData(originalData);
        postData.dataTables.pageNum = pageNum;
        $.ajax({
            type: "POST",
            url: "/MangaInfo/listMangaInfo",
            dataType: "JSON",
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify(postData),
            success: function (response) {
                pageReload(response);
            }
        });
    }

    function searchPageLoad(searchData) {
        let searchPostData = {searchData: searchData};
        $.ajax({
            url: "/MangaInfo/search",
            type: "POST",
            contentType: "application/json;charset=UTF-8",
            dataType: "JSON",
            data: JSON.stringify(searchPostData),
            success: function (response) {
                pageReload(response);
            },
            error: function (e) {
                console.log(e);
            }
        });
    }

</script>
</html>