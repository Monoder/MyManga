<!DOCTYPE html>
<html lang="ch">
<head>
    <meta charset="UTF-8">
    <title>index</title>
    <link rel="stylesheet" href="./css/public-frame.css">
    <link rel="stylesheet" href="./css/index.css">

    <script src="./js/frame/jquery-3.6.0.js"></script>
    <script src="./js/public/public-frame.js"></script>
    <style>
        @supports (display:grid) {
            .manga_grid {
                display: grid;
                grid-template-columns:repeat(5, 1fr)
            }

            .wrapper_content {
                min-width: 250px;
            }

            @media screen and (max-width: 1360px) {
                .manga_grid {
                    grid-template-columns:repeat(4, 1fr)
                }

                .wrapper_content:nth-child(8n+1), .wrapper_content:nth-child(8n+3), .wrapper_content:nth-child(8n+6), .wrapper_content:nth-child(8n+8) {
                    background-color: rgba(72, 61, 139, 0.3);
                }

                .wrapper_content:nth-child(8n+2), .wrapper_content:nth-child(8n+4), .wrapper_content:nth-child(8n+5), .wrapper_content:nth-child(8n+7) {
                    background-color: rgba(72, 61, 139, 0.3);
                }
            }
            @media screen and (max-width: 1090px) {
                .manga_grid {
                    grid-template-columns:repeat(3, 1fr)
                }

                .wrapper_content:nth-child(2n+1) {
                    background-color: rgba(72, 61, 139, 0.3);
                }

                .wrapper_content:nth-child(2n+2) {
                    background-color: rgba(72, 61, 139, 0.3);
                }
            }
            @media screen and (max-width: 820px) {
                .manga_grid {
                    grid-template-columns:repeat(2, 1fr)
                }

                .wrapper_content:nth-child(4n+1), .wrapper_content:nth-child(4n+4) {
                    background-color: rgba(72, 61, 139, 0.3);
                }

                .wrapper_content:nth-child(4n+2), .wrapper_content:nth-child(4n+3) {
                    background-color: rgba(72, 61, 139, 0.3);
                }
            }
        }
    </style>

</head>
<body>

<div class="page_content" style="max-width:1370px">

    <!-- BodyHeader -->
    <h1 class="head_title">Monoder - Just For Fun</h1>
    <div id="head_wrapper">
        <div class="head_form_wrapper">

            <div data-id="" class="category_wrapper">
                <table id="category_table">
                    <tbody>
                    <tr>
                        <td>
                            <div data-id="00" class="category cat-00">Doujinshi</div>
                        </td>
                        <td>
                            <div data-id="01" class="category cat-01">Manga</div>
                        </td>
                        <td>
                            <div data-id="02" class="category cat-02">Artist CG</div>
                        </td>
                        <td>
                            <div data-id="03" class="category cat-03">Game CG</div>
                        </td>
                        <td>
                            <div data-id="04" class="category cat-04">Western</div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div data-id="05" class="category cat-05">Non-H</div>
                        </td>
                        <td>
                            <div data-id="06" class="category cat-06">Image Set</div>
                        </td>
                        <td>
                            <div data-id="07" class="category cat-07">Cosplay</div>
                        </td>
                        <td>
                            <div data-id="08" class="category cat-08">Asian Porn</div>
                        </td>
                        <td>
                            <div data-id="09" class="category cat-09">Misc</div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <form id="search-form">
                <span class="bg search_input_wrapper">

                    <input id="search_know" class="search_input" maxlength="255" autocomplete="off">

                </span><span class="bg search_btn_wr">

                <input type="button" id="search-btn" value="Search" class="bg search_btn" onclick="searchSubmit( )">

            </span>
            </form>

        </div>
    </div>

    <!-- BodyContent -->
    <div id="body_wrapper">
        <p class="info">Showing results</p>
        <!--        <p class="info"></p>-->
        <table class="page_bar" style="margin:2px auto 0px">
            <tr>
                <td class="page_change" onclick="getPreviousPage()">&lt;</td>
                <!--
                                                <td class="page_num"><a href="" onclick="">1</a></td>
                                                <td class="page_num"><a href="" onclick="return false">2</a></td>
                                                <td class="page_num"><a href="" onclick="return false">3</a></td>
                                                <td class="page_num"><a>…</a></td>
                                                <td class="page_num"><a href="" onclick="return false">7</a></td>
                -->
                <td class="page_change" onclick="getNextPage()">&gt;</td>
            </tr>
        </table>

        <!-- 从后端获取数据 ajax 加入该类中 -->
        <div id="manga-wrapper" class="manga_grid">

        </div>

        <table class="page_bar" style="margin:0px auto">
            <tr>
                <td class="page_change" onclick="getPreviousPage()">&lt;</td>
                <!--
                <td class="page_num"><a href="" onclick="return false">1</a></td>
                <td class="page_num"><a>…</a></td>
                <td class="page_num"><a href="" onclick="return false">4</a></td>
                <td class="page_num"><a href="" onclick="return false">5</a></td>
                <td class="page_num"><a href="" onclick="return false">6</a></td>
                <td class="page_num"><a>…</a></td>
                <td class="page_num"><a href="" onclick="return false">7</a></td>
                -->
                <td class="page_change" onclick="getNextPage()">&gt;</td>
            </tr>
        </table>
    </div>
    <p class="info">
    </p>
</div>
</body>
<script type="text/javascript" src="js/public/public-navigation.js"></script>
<script>

    let pageNumURL = getUrlParam( "pageNum" );
    let pageNum = pageNumURL;

    if ( pageNum == null ) {
        pageNum = 1
    }


    // 加载框架
    $( document ).ready( function () {
        let originalData = { "pageNum": pageNum };
        let postData = dataTablePostData( originalData );

        let listMangeInfo = $.ajax( {
            type: "POST",
            url: "/MangaInfo/listMangaInfo",
            dataType: "JSON",
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify(postData),
            success: function ( response ) {
                let pageInfo = response.data;

                // 渲染页面提示信息
                $( "#body_wrapper .info" ).text( "Showing " + pageInfo.total + " results" );

                // 渲染图片框架
                let dom_mangaWrapper = $( "#manga-wrapper" );
                initWrapperContainer( dom_mangaWrapper, pageInfo );

                // 图片资源渲染
                let wrapperImg = $( ".wrapper_body img" );
                initWrapperSource( wrapperImg, pageInfo )

                // 分页实现
                let dom_pageBar_tr = $( ".page_bar tr" );
                initPageBar( dom_pageBar_tr, pageInfo );

            },
            error: function () {

            }

        } );

        let searchText = getUrlParam( "searchValue" );
        let categoryList = getCategoryList( getUrlParam( "catsStr" ) );

        // dom_category 加载完成后执行
        let dom_category = $( ".category" );
        dom_category.ready( function () {
            initCategoryBar( dom_category, searchText, categoryList );
        } );

        // dom_category 点击事件
        dom_category.click( function () {
            let that = $( this );
            let isChoose = that.attr( "data-isChoose" );
            if ( isChoose === "true" ) {
                that.attr( "data-isChoose", false )
            } else if ( isChoose === "false" ) {
                that.attr( "data-isChoose", true )
            }
        } )

        // 分页点击切换


    } );

    // 搜索框提交
    function searchSubmit() {
        let searchValue = $( "#search_know" ).val();
        let catsStr = listCategory( $( ".category" ) );
        let subData = { searchValue: searchValue, catsStr: catsStr };
        $( window ).attr( "location", "index.html?" + $.param( subData ) );
    }


    /**
     * 获取当前 url 地址，正则提取 get 传递的参数
     * @param name  需要提取的参数名
     * @returns {string|null} 参数值
     */
    function getUrlParam( name ) {
        //构造一个含有目标参数的正则表达式对象
        let reg = new RegExp( "(^|&)" + name + "=([^&]*)(&|$)" );
        //匹配目标参数
        let r = window.location.search.substr( 1 ).match( reg );
        if ( r != null ) return unescape( r[ 2 ] );
        //返回参数值
        return null;
    }

    /**
     *
     * @param catsStr  从 url 获取的 cats 字符串
     * @returns {null|*} 分割开的 list 集合
     */
    function getCategoryList( catsStr ) {
        if ( catsStr === null ) {
            return null;
        }
        return catsStr.split( "_" )
    }


    /**
     *
     * @param dom_category  .category 的 jQuery 对象
     * @returns {null}  data-isChoose = true 的 dom_catId 集合
     */
    function listCategory( dom_category ) {
        let catsStr = null;
        for ( let i = 0; i < dom_category.length; i++ ) {
            let flag = dom_category.eq( i ).attr( "data-isChoose" );
            let dom_catId = dom_category.eq( i ).attr( "data-id" );
            if ( flag === "true" ) {
                if ( catsStr === null ) {
                    catsStr = dom_catId;
                } else {
                    catsStr = catsStr + "_" + dom_catId;
                }
            }
        }
        return catsStr;
    }


    /**
     *  渲染生成页面图片容器框架
     * @param dom_mangaWrapper  .wrapper_body img 的 jQuery 对象
     * @param pageInfo  pageInfo 结果集合
     */
    function initWrapperContainer( dom_mangaWrapper, pageInfo ) {

        let listMangaInfo = pageInfo.list;
        // 遍历添加 MangaWrapper 节点框架
        for ( let i = 0; i < pageInfo.size; i++ ) {
            let mangaGuid = listMangaInfo[ i ].guid;
            let mangaName = listMangaInfo[ i ].name;
            let mangaPageCount = listMangaInfo[ i ].pageCount;
            $( "#manga-wrapper" ).append(
                    "            <div class=\"wrapper_content\">\n" +
                    "                <div class=\"wrapper_title\" title = \"" + mangaName + "\">\n" +
                    "                    <a href=\"/web/MangaDetail.html?mainGuid=" + mangaGuid + "\">" + mangaName + "</a>\n" +
                    "                </div>\n" +
                    "                <div class=\"wrapper_body\">\n" +
                    "                    <a class=\"wrapper_source\" href=\"/web/MangaDetail.html?mainGuid=" + mangaGuid + "\">\n" +
                    "                        <img data-id=\"" + mangaGuid + "\" alt=\"" + mangaName + "\" />\n" +
                    "                    </a>\n" +
                    "                </div>\n" +
                    "                <div class=\"wrapper_foot\">\n" +
                    "                    <div>\n" +
                    "                        <div class=\"wrapper_category cat-05\">Non-H</div>\n" +
                    "                        <div onclick=\"\" id=\"\">2020-02-27 14:54</div>\n" +
                    "                    </div>\n" +
                    "                    <div>\n" +
                    "                    <div><div>" + mangaPageCount + " pages</div></div>\n" +
                    "                </div>\n" +
                    "            </div>\n"
            )
        }

    }


    /**
     *  请求加载后端图片数据
     * @param dom_wrapperImg  .wrapper_body img 的 jQuery 对象
     * @param pageInfo  pageInfo 结果集合
     */
    function initWrapperSource( dom_wrapperImg, pageInfo ) {
        // 遍历，在框架中根据封面 Guid 请求封面图片
        for ( let i = 0; i < pageInfo.size; i++ ) {
            let wrapperGuid = dom_wrapperImg.eq( i ).attr( "data-id" );
            $.ajax( {
                type: "post",
                datatype: "String",
                data: { guid: wrapperGuid },
                url: "/MangaInfo/getWrapper",
                success: function ( wrapperSource ) {
                    // manga_img 需要在 success 中进行取值，不然会一直为遍历最后一个值
                    let manga_img = dom_wrapperImg.eq( i );
                    manga_img.attr( "src", wrapperSource );
                }
            } );
        }
    }


    /**
     * 渲染生成导航栏
     * @param dom_pageBar  .page_bar tr 的 jQuery 对象
     * @param pageInfo  pageInfo 结果集合
     */
    function initPageBar( dom_pageBar, pageInfo ) {
        // 当前页码
        let pageNum = pageInfo.pageNum;
        // 总页码
        let pages = pageInfo.pages;
        // 上一页、下一页
        let dom_pageChange = $( ".page_change" );
        init( dom_pageChange.eq( 1 ) );
        init( dom_pageChange.eq( 3 ) );

        function init( dom_nextPage ) {
            // 总页数小于5， 直接生成  < 1 2 3 4 5 >
            if ( pages <= 5 ) {
                for ( let i = 1; i <= pages; i++ ) {
                    dom_nextPage.before( "<td class=\"page_num\" onclick=\"pageChange( " + i + " )\">" + i + "</td>" );
                }
            }
            // 总页数大于5，分情况生成
            else if ( pages > 5 ) {
                // 页码小于3，生成 < 1 2 3 … n >
                if ( pageNum <= 3 ) {
                    for ( let i = 1; i <= 3; i++ ) {
                        dom_nextPage.before( "<td class=\"page_num\" onclick=\"pageChange( " + i + " )\">" + i + "</td>" );
                    }
                    dom_nextPage.before( "<td class=\"page_num\">…</td>" )
                            .before( "<td class=\"page_num\" onclick=\"pageChange( " + pages + " )\">" + pages + "</td>" );
                }
                // 页码大于3，小于等于总页码-3，生成 < 1 … 4 5 6 … n >
                else if ( pageNum > 3 && pageNum <= (pages - 3) ) {
                    dom_nextPage.before( "<td class=\"page_num\" onclick=\"pageChange( 1 )\">1</td>" )
                            .before( "<td class=\"page_num\">…</td>" )
                            .before( "<td class=\"page_num\" onclick=\"pageChange( " + (pageNum - 1) + " )\">" + (pageNum - 1) + "</td>" )
                            .before( "<td class=\"page_num\" onclick=\"pageChange( " + pageNum + " )\">" + pageNum + "</td>" )
                            .before( "<td class=\"page_num\" onclick=\"pageChange( " + (pageNum + 1) + " )\">" + (pageNum + 1) + "</td>" )
                            .before( "<td class=\"page_num\">…</td>" )
                            .before( "<td class=\"page_num\" onclick=\"pageChange( " + pages + " )\">" + pages + "</td>" );
                }
                // 页码大于总页码-3，小于总页码-3，生成 < 1 … 6 7 8 >
                else if ( pageNum > pages - 3 ) {
                    dom_nextPage.before( "<td class=\"page_num\" onclick=\"pageChange( 1 )\">1</td>" )
                            .before( "<td class=\"page_num\">…</td>" );
                    for ( let i = pageNum - 1; i <= pages; i++ ) {
                        dom_nextPage.before( "<td class=\"page_num\" onclick=\"pageChange( " + i + " )\">" + i + "</td>" );
                    }
                }
            }
        }

        // 修改当前页样式
        let dom_pageNum = $( ".page_num" );
        for ( let i = 0; i < dom_pageNum.length; i++ ) {
            if ( dom_pageNum[ i ].innerText == pageNum ) {
                dom_pageNum.eq( i ).attr( "data-isCurrent", "true" );
            }
        }

        // 控制页码切换隐藏
        if ( pageInfo.hasPreviousPage == false ) {
            dom_pageChange.eq( 0 ).attr( "data-isShow", "false" );
            dom_pageChange.eq( 2 ).attr( "data-isShow", "false" );
        }
        if ( pageInfo.hasNextPage == false ) {
            dom_pageChange.eq( 1 ).attr( "data-isShow", "false" );
            dom_pageChange.eq( 3 ).attr( "data-isShow", "false" );
        }

    }


    /**
     *  分类栏加载后的事件
     *  let dom_category = $( ".category" );
     * @param dom_category  .category 的 jQuery 对象
     * @param searchText  搜索框搜索内容文本
     * @param categoryList  选择搜索的分类集合
     */
    function initCategoryBar( dom_category, searchText, categoryList ) {
        // 判断 URL - categoryList 是否为空，为空则默认加载为 true
        if ( categoryList === null ) {
            dom_category.attr( "data-isChoose", true );
        } else {
            // URL - categoryList 有传参，则遍历 dom 树，判断传参集合里是否包含 dom 树 data-id
            for ( let i = 0; i < dom_category.length; i++ ) {
                let dom_cat = dom_category.eq( i );
                let dom_catId = dom_cat.attr( "data-id" );
                if ( categoryList.indexOf( dom_catId ) < 0 ) {
                    // 包含则设为 false
                    dom_cat.attr( "data-isChoose", false )
                } else {
                    dom_cat.attr( "data-isChoose", true )
                }
            }
        }
    }

    function pageChange( targetPageNum ) {
        pageNum = targetPageNum
        let subData = { pageNum: targetPageNum }
        $( window ).attr( "location", "index.html?" + $.param( subData ) );
    }

    function getPreviousPage() {
        pageNum--;
        let subData = { pageNum: pageNum }
        $( window ).attr( "location", "index.html?" + $.param( subData ) );
    }

    function getNextPage() {
        pageNum++;
        let subData = { pageNum: pageNum }
        $( window ).attr( "location", "index.html?" + $.param( subData ) );
    }

    // src=\"data:image/jpeg;base64," + wrapper.wrapperSource

</script>
</html>