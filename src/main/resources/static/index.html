<!DOCTYPE html>
<html lang="ch">
<head>
    <meta charset="UTF-8">
    <title>index</title>

    <link rel="stylesheet" href="./css/public-frame.css">
    <link rel="stylesheet" href="./css/index.css">

    <script src="./js/frame/jquery-3.6.0.js"></script>
    <script src="./js/public/public-frame.js"></script>
    <script type="text/javascript" src="./js/public/public-navigation.js"></script>
    <style>
        @supports (display:grid) {
            .manga_grid {
                display: grid;
                grid-template-columns:repeat(5, 1fr)
            }

            .wrapper_content {
                min-width: 250px;
            }

            @media screen and (max-width: 1360px) {
                .manga_grid {
                    grid-template-columns:repeat(4, 1fr)
                }

                .wrapper_content:nth-child(8n+1), .wrapper_content:nth-child(8n+3), .wrapper_content:nth-child(8n+6), .wrapper_content:nth-child(8n+8) {
                    background-color: rgba(72, 61, 139, 0.3);
                }

                .wrapper_content:nth-child(8n+2), .wrapper_content:nth-child(8n+4), .wrapper_content:nth-child(8n+5), .wrapper_content:nth-child(8n+7) {
                    background-color: rgba(72, 61, 139, 0.3);
                }
            }
            @media screen and (max-width: 1090px) {
                .manga_grid {
                    grid-template-columns:repeat(3, 1fr)
                }

                .wrapper_content:nth-child(2n+1) {
                    background-color: rgba(72, 61, 139, 0.3);
                }

                .wrapper_content:nth-child(2n+2) {
                    background-color: rgba(72, 61, 139, 0.3);
                }
            }
            @media screen and (max-width: 820px) {
                .manga_grid {
                    grid-template-columns:repeat(2, 1fr)
                }

                .wrapper_content:nth-child(4n+1), .wrapper_content:nth-child(4n+4) {
                    background-color: rgba(72, 61, 139, 0.3);
                }

                .wrapper_content:nth-child(4n+2), .wrapper_content:nth-child(4n+3) {
                    background-color: rgba(72, 61, 139, 0.3);
                }
            }
        }
    </style>

</head>
<body>
<div class="page_content" style="max-width:1370px">

    <!-- BodyHeader -->
    <h1 class="head_title">Monoder - Just For Fun</h1>
    <div id="head_wrapper">
        <div class="head_form_wrapper">

            <div data-id="" class="category_wrapper">
                <table id="category_table">
                    <tbody>
                    <tr>
                        <td>
                            <div data-id="42390000" class="category">Doujinshi</div>
                        </td>
                        <td>
                            <div data-id="42391111" class="category">Manga</div>
                        </td>
                        <td>
                            <div data-id="42392222" class="category">Artist CG</div>
                        </td>
                        <td>
                            <div data-id="42393333" class="category">Game CG</div>
                        </td>
                        <td>
                            <div data-id="42394444" class="category">Western</div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div data-id="42395555" class="category">Non-H</div>
                        </td>
                        <td>
                            <div data-id="42396666" class="category">Image Set</div>
                        </td>
                        <td>
                            <div data-id="42397777" class="category">Cosplay</div>
                        </td>
                        <td>
                            <div data-id="42398888" class="category">Asian Porn</div>
                        </td>
                        <td>
                            <div data-id="42399999" class="category">Misc</div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <form id="search-form">
                <span class="bg search_input_wrapper">

                    <input id="search_know" class="search_input" maxlength="255" autocomplete="off">

                </span><span class="bg search_btn_wr">

                <input type="button" id="search-btn" value="Search" class="bg search_btn" onclick="searchSubmit( )">

            </span>
            </form>

        </div>
    </div>

    <!-- BodyContent -->
    <div id="body_wrapper">
        <p class="info">Showing results</p>
        <!--        <p class="info"></p>-->
        <table class="page_bar" style="margin:2px auto 0">
            <tr>
            </tr>
        </table>

        <!-- 从后端获取数据 ajax 加入该类中 -->
        <div id="manga-wrapper" class="manga_grid">

        </div>

        <table class="page_bar" style="margin:0 auto">
            <tr>
            </tr>
        </table>
    </div>
    <p class="info">
    </p>
</div>
</body>

<script>

    // 设置页数
    let pages = 2;
    let pageNum = 1;

    // 定义常用的 jQuery 对象
    const sel_$category = ".category";
    const sel_$mangaWrapper = "#manga-wrapper";
    const sel_$bodyWrapper_Info = "#body_wrapper .info";
    const sel_$wrapperBody_Img = ".wrapper_body img";
    const sel_$pageBar_Tr = ".page_bar tr";

    let $category = $( sel_$category );
    let $mangaWrapper = $( sel_$mangaWrapper );
    let $bodyWrapper_Info=$(sel_$bodyWrapper_Info);
    let $wrapperBody_Img = $(sel_$wrapperBody_Img);
    let $pageBar_Tr = $(sel_$pageBar_Tr);

    // 加载框架
    $(document).ready(function () {
        // 封装 DataTables 类型数据用于发送请求
        let dataTablesData = {pageNum: pageNum};
        let postData = getDataTablesPostData(dataTablesData);
        let listMangeInfo = $.ajax({
            type: "POST",
            url: "/MangaInfo/listMangaInfo",
            dataType: "JSON",
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify(postData),
            success: (response) => {
                pageReload(response);
            },
            error: () => {
            }
        });

        // listMangeInfo 加载完成后执行
        listMangeInfo.done(function (response) {
            let searchData = response.searchData;
            $category = $( sel_$category );
            initCategoryBar($category, searchData.searchText, searchData.categoryIdList);
        });

        // 分类的点击切换事件
        $category = $( sel_$category );
        $category.click(function () {
            let that = $(this);
            if (that.attr("data-disabled") === undefined) {
                that.attr("data-disabled", "");
            } else {
                that.removeAttr("data-disabled");
            }
        });

    });

    // 搜索框提交
    function searchSubmit() {
        // 获取搜索内容
        let searchText = $("#search_know").val();
        // 遍历获取CategoryIdList
        let categoryIdList = [];
        $category = $( sel_$category );
        $category.each(function () {
            if (!$(this).attr("data-disabled")) {
                categoryIdList.push($(this).attr("data-id"));
            }
        });
        // 封装 SearchData 类型数据用于发送请求
        let searchData = {searchText: searchText, categoryIdList: categoryIdList};
        // 发送请求重载页面
        searchPageLoad(searchData);
    }


    /**
     *  渲染页面漫画封面的容器框架部分
     *  let $mangaWrapper = $("#manga-wrapper");
     * @param $mangaWrapper  ( #manga-wrapper ) 漫画封面的 jQuery 对象
     * @param pageInfo  PageHelper 分页后的结果集合
     */
    function initWrapperContainer($mangaWrapper, pageInfo) {
        // 获取数据
        let listMangaInfo = pageInfo.list;
        listMangaInfo.forEach((mangaInfo) => {
            let {guid: mangaGuid, mangaName, pageCount: mangaPageCount, updateTime: mangaUpdateTime, dicEnumCategoryDTO: mangaCategory } = mangaInfo;
            // 使用模板字符串
            $mangaWrapper.append(`
    <div class="wrapper_content">
        <div class="wrapper_title" title="${mangaName}">
            <a href="/web/MangaDetail.html?mainGuid=${mangaGuid}">${mangaName}</a>
        </div>
        <div class="wrapper_body">
            <a class="wrapper_source" href="/web/MangaDetail.html?mainGuid=${mangaGuid}">
                <img data-id="${mangaGuid}" alt="${mangaName}"/>
            </a>
        </div>
        <div class="wrapper_foot">
            <div>
                <div class="wrapper_category category" data-id="${mangaCategory.dicEnumID}">${mangaCategory.dicEnumName}</div>
                <div id="">${mangaUpdateTime}</div>
            </div>
            <div>
                <div>
                    <div>${mangaPageCount} pages</div>
                </div>
            </div>
        </div>
    </div>
    `);
        });
    }

    /**
     * 请求并渲染页面的漫画封面
     * let $wrapperBody_Img = $(".wrapper_body img");
     * @param $wrapperBody_Img (.wrapper_body img) 漫画封面图片部分的 jQuery 对象
     */
    function initWrapperSource($wrapperBody_Img) {
        // 在框架中根据封面 Guid 循环请求封面图片
        $wrapperBody_Img.each((index, element) => {
            let wrapperGuid = $(element).attr("data-id");
            $.ajax({
                type: "post",
                // dataType: "text",
                data: {mangaGuid: wrapperGuid},
                url: "/MangaInfo/getWrapper",
                success: (wrapperSource) => {
                    $(element).attr("src", wrapperSource);
                },
                error: (xhr, textStatus, errorThrown) => {
                    console.log(xhr.responseText);
                }
            })
        });
    }

    /**
     * 分类栏加载后渲染分类栏的 data-isChoose，使得支持点击切换样式
     *  let $category = $( ".category" );
     * @param $category  ( .category ) 的 jQuery 对象
     * @param searchText  搜索框搜索内容文本
     * @param categoryIdList  选择的分类ID集合
     */
    function initCategoryBar($category, searchText, categoryIdList) {
        // 判断 categoryIdList 是否为空，为空则默认加载为 true
        if (categoryIdList.length === 0) {
            $category.attr("data-isChoose", true);
        } else {
            // categoryIdList 不为空，则遍历 dom 树，判断传参集合里是否包含 dom 的 data-id
            $category.each((index, element) => {
                let $cat = $(element);
                let $catId = $cat.attr("data-id");
                if (categoryIdList.length === 0 || categoryIdList.indexOf($catId) >= 0) {
                    $cat.attr("data-isChoose", true);
                } else {
                    $cat.attr("data-isChoose", false);
                }
            });
        }
    }

    /**
     * 渲染分页栏
     * let $pageBar_Tr = $(".page_bar tr");
     * @param $pageBar_Tr   ( .page_bar tr ) 分页栏渲染的 jQuery 对象
     * @param pageInfo - PageHelper 分页后的结果集合
     */
    function initPageBar($pageBar_Tr, pageInfo) {
        // 获取当前页和总页数
        let {pageNum, pages} = pageInfo;

        // 定义跳转页数的函数
        let changePage = newPageNum => {
            pageNum = newPageNum;
            pageChangeLoad(pageNum);
        };

        // 计算页码的起始和结束位置
        let pageStart = 1;
        let pageEnd = pages;
        if (pages > 5) {
            if (pageNum <= 3) {
                pageEnd = 5;
            } else if (pageNum >= pages - 2) {
                pageStart = pages - 4;
            } else {
                pageStart = pageNum - 2;
                pageEnd = pageNum + 2;
            }
        }

        // 渲染页码元素
        $pageBar_Tr.empty().append(`
    <td class="page_change" onclick="getPreviousPage()" data-isShow="${pageInfo.hasPreviousPage}">&lt;</td>
    ${pageStart > 1 ? `<td class="page_num" onclick="pageChange(1)">1</td>
                        <td class="page_num" onclick="pageChange(${pageStart - 1})">...</td>` : ""}
    ${Array.from({length: pageEnd - pageStart + 1}, (_, i) => pageStart + i)
            .map(page => `<td class="page_num" onclick="pageChange(${page})" data-isCurrent="${page === pageNum}">${page}</td>`)
            .join("")}
    ${pageEnd < pages ? `<td class="page_num" onclick="pageChange(${pageEnd + 1})">...</td>
                        <td class="page_num" onclick="pageChange(${pages})">${pages}</td>` : ""}
    <td class="page_change" onclick="getNextPage()" data-isShow="${pageInfo.hasNextPage}">&gt;</td>
  `);
    }

    function pageChange(targetPageNum) {
        pageNum = targetPageNum;
        pageChangeLoad(pageNum);
    }

    function getPreviousPage() {
        if (pageNum > 1) {
            pageNum--;
            pageChangeLoad(pageNum);
        }
    }

    function getNextPage() {
        if (pageNum < pages) {
            pageNum++;
            pageChangeLoad(pageNum);
        }
    }


    function pageReload(responseData) {
        let pageInfo = responseData.data;
        pages = pageInfo.pages;

        // 渲染页面提示信息
        $bodyWrapper_Info=$(sel_$bodyWrapper_Info);
        $bodyWrapper_Info.empty().text("Showing " + pageInfo.total + " results");

        // 渲染图片框架
        $mangaWrapper = $( sel_$mangaWrapper );
        $mangaWrapper.empty();
        initWrapperContainer($mangaWrapper, pageInfo);

        // 图片资源渲染
        $wrapperBody_Img = $(sel_$wrapperBody_Img);
        $wrapperBody_Img.empty();
        initWrapperSource($wrapperBody_Img);

        // 分页实现
        $pageBar_Tr = $(sel_$pageBar_Tr);
        $pageBar_Tr.empty();
        initPageBar($pageBar_Tr, pageInfo);
    }

    /**
     * 根据页码请求后台新的分页数据
     * @param pageNum
     */
    function pageChangeLoad(pageNum) {
        let originalData = {pageNum};
        let postData = getDataTablesPostData(originalData);
        postData.dataTables.pageNum = pageNum;
        $.ajax({
            type: "POST",
            url: "/MangaInfo/listMangaInfo",
            dataType: "JSON",
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify(postData),
            success: function (response) {
                pageReload(response);
            }
        });
    }

    function searchPageLoad(searchData) {
        let searchPostData = {searchData: searchData};
        $.ajax({
            url: "/MangaInfo/search",
            type: "POST",
            contentType: "application/json;charset=UTF-8",
            dataType: "JSON",
            data: JSON.stringify(searchPostData),
            success: function (response) {
                pageReload(response);
            },
            error: function (e) {
                console.log(e);
            }
        });
    }

</script>
</html>